# rsyslog sample configuration for Docker container
# Minimal config that accepts syslog on UDP/TCP and logs to files and stdout

# Load modules
module(load="imuxsock")   # Unix socket input
module(load="imudp")      # UDP input
module(load="imtcp")      # TCP input
module(load="omazuredce") # load the new output module (omazuredce)
#module(load="omstdout")   # stdout output (modern module)

# Input from UDP (port 514)
input(type="imudp" port="514")

# Unix socket for local logging
input(type="imuxsock" socket="/dev/log")

# Set default permissions for all log files
$FileOwner syslog
$FileGroup adm
$FileCreateMode 0640
$DirCreateMode 0755
$Umask 0022

# Define templates for log output (modern RainerScript)
template(name="RFC3164fmt" type="string"
         string="%HOSTNAME% %syslogtag%%msg:::sp-if-no-1st-sp%%msg:::drop-last-lf%\n")
template(name="RFC5424fmt" type="string"
         string="%TIMESTAMP:::date-rfc3339% %HOSTNAME% %syslogtag% %msg%\n")
template(name="DynFile" type="string"
         string="/var/log/rsyslog/%HOSTNAME%/syslog")

# Ruleset used only by TCP/514 input
ruleset(name="tcp514_to_azure") {
  # Forward only TCP/514 logs to Azure Log Ingestion API
  action(
    type="omazuredce"
    template="RFC3164fmt"
    queue.type="LinkedList"
    queue.size="10000"
    queue.dequeuebatchsize="1000"
    queue.workerthreads="1"
    client_id=""
    client_secret=""
    tenant_id=""
    dce_url=""
    dcr_id=""
    table_name="Custom-Ingested_CL"
    time_generated="on"
    max_batch_bytes="1048576"
    flush_timeout_ms="2000"
  )
}

# Input from TCP (port 514) - bound to Azure ruleset
input(type="imtcp" port="514" ruleset="tcp514_to_azure")

# Send emergency messages to root as well
*.emerg   action(type="omusrmsg" users="root")

# For debugging
# Turn on debug logging to see detailed info
# $DebugFile /var/log/rsyslog-debug.log
# $DebugLevel 2
